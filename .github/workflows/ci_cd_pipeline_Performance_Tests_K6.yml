name: Dockerized Load Test Execution

on:
  schedule:
    - cron: '30 6 * * *'  # Daily at 06:30 UTC
  push:
    branches: [main, master, dev, feature]
  pull_request:
    branches: [main, master, dev, feature]

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start infrastructure with Docker Compose
        run: |
          docker compose -f docker-compose.yml up -d --build
          docker compose ps

      - name: Wait for InfluxDB to be ready
        run: |
          timeout 60 bash -c 'until docker compose exec influxdb influx -execute "SHOW DATABASES"; do sleep 2; done'

      - name: Run k6 load test
        run: docker compose up --build k6

      - name: Upload test summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: ./load-test-results/summary.json

      - name: Capture logs on failure
        if: failure()
        run: |
          docker compose logs --no-color > all-logs.txt
          docker compose logs --no-color k6 > k6-detailed.log

      - name: Upload service logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: service-logs
          path: |
            all-logs.txt
            k6-detailed.log

      - name: Tear down containers
        if: always()
        run: docker compose down -v